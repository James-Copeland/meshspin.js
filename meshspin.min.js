function MeshSpin(t,e){this.fig=t,this.scaleFactor=e,this.fps=60,this.viewBox=[-100,-100,200,200],this.fake3D=!1,this.debug=!1,this.edgeSeperator=",",this.background=!1,this.fillColor=null,this.staticRotation={x:.01,y:.01,z:.01},this.scale=function(){this.fig.nodes=this.fig.nodes.map(t=>({x:t.x*this.scaleFactor,y:t.y*this.scaleFactor,z:t.z*this.scaleFactor}))},this.rotate=(t=>this.fig.nodes.map(e=>({x:e.x*Math.cos(t.x)-e.z*Math.sin(t.x),y:e.y,z:e.z*Math.cos(t.x)+e.x*Math.sin(t.x)})).map(e=>({x:e.x,y:e.y*Math.cos(t.y)-e.z*Math.sin(t.y),z:e.z*Math.cos(t.y)+e.y*Math.sin(t.y)})).map(e=>({x:e.x*Math.cos(t.z)-e.y*Math.sin(t.z),y:e.y*Math.cos(t.z)+e.x*Math.sin(t.z),z:e.z}))),this.sortEdges=function(t){for(i=0;i<t.length;++i)t[i].sort();var e=t.map(t=>t.join(this.edgeSeperator)).filter((t,e,s)=>s.indexOf(t)===e);return e.sort(),e},this.setup=function(t){this.fig.edges=this.sortEdges(this.fig.edges),this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("viewBox",this.viewBox.join(" ")),this.ns=this.svg.namespaceURI,document.getElementById(t).appendChild(this.svg),this.scale(),document.addEventListener("mousemove",this.mouseUpdate(),!1),document.addEventListener("mouseenter",this.mouseUpdate(),!1)},this.nextOutlineNode=function(t,e){function s(t,e){return{x:t.x-e.x,y:t.y-e.y}}prevNode=null===e?{x:this.fig.nodes[t].x-1,y:this.fig.nodes[t].y}:this.fig.nodes[e],prevVector=s(this.fig.nodes[t],prevNode);var i,n,o=this.fig.nodes.map(e=>s(e,this.fig.nodes[t])).map(t=>(i=prevVector,n=t,Math.acos((i.x*n.x+i.y*n.y)/(Math.sqrt(i.x*i.x+i.y*i.y)*Math.sqrt(n.x*n.x+n.y*n.y))))).map((s,i)=>i==t||i==e||isNaN(s)?7:s);return o.indexOf(Math.min.apply(Math,o))},this.outlineEdges=function(){var t=[],e=[],s=this.fig.nodes.map(t=>t.x),i=s.indexOf(Math.max.apply(Math,s)),n=null,o=i;do{next=this.nextOutlineNode(o,n),t.push(o),e.push([o,next]),n=o,o=next}while(o!=i);return e=this.sortEdges(e),this.background&&(this.backgroundPoly=t.map(t=>this.fig.nodes[t].x.toString()+","+this.fig.nodes[t].y.toString())),[t,e]},this.fake3Dedges=function(){var t=this.outlineEdges();outlineNodes=t[0];var e=t[1].concat(this.fig.edges.map(t=>t.split(this.edgeSeperator).map(t=>parseInt(t))).filter(t=>this.fig.nodes[t[0]].z>=0&&this.fig.nodes[t[1]].z>=0||this.fig.nodes[t[0]].z>=this.fig.nodes[t[1]].z&&outlineNodes.indexOf(t[1])>=0&&-1==outlineNodes.indexOf(t[0])||this.fig.nodes[t[1]].z>=this.fig.nodes[t[0]].z&&outlineNodes.indexOf(t[0])>=0&&-1==outlineNodes.indexOf(t[1])).map(t=>t.join(this.edgeSeperator))).filter((t,e,s)=>s.indexOf(t)===e);return e.sort(),e},this.draw=function(){for(;this.svg.lastChild;)this.svg.removeChild(this.svg.lastChild);var t=this.getRotationOffset();this.fig.nodes=this.rotate(t);var e=this.fake3D?this.fake3Dedges():this.fig.edges;if(this.background){var s=document.createElementNS(this.ns,"polygon");s.setAttribute("points",this.backgroundPoly.join(" ")),s.setAttribute("class","meshspin-background"),this.fillColor&&s.setAttribute("fill",this.fillColor),this.svg.appendChild(s)}for(n=0;n<e.length;n++){var i=e[n].split(this.edgeSeperator),o=document.createElementNS(this.ns,"line");o.setAttribute("x1",this.fig.nodes[i[0]].x),o.setAttribute("y1",this.fig.nodes[i[0]].y),o.setAttribute("x2",this.fig.nodes[i[1]].x),o.setAttribute("y2",this.fig.nodes[i[1]].y),o.setAttribute("stroke",this.color()),o.setAttribute("class","meshspin-line"),this.svg.appendChild(o)}this.debug&&this.drawDebugNodes()},this.drawDebugNodes=function(){for(n=0;n<this.fig.nodes.length;n++){var t=document.createElementNS(this.ns,"text");t.setAttribute("x",this.fig.nodes[n].x),t.setAttribute("y",this.fig.nodes[n].y),t.appendChild(document.createTextNode(n)),this.svg.appendChild(t);var e=document.createElementNS(this.ns,"circle");e.setAttribute("cx",this.fig.nodes[n].x),e.setAttribute("cy",this.fig.nodes[n].y),e.setAttribute("r","3px"),e.setAttribute("stroke","transparent"),e.setAttribute("fill",this.fig.nodes[n].z<0?"#666":"black"),this.svg.appendChild(e)}},this.animationFrameCallback=function(){var t=this;return function e(s){requestAnimationFrame(e),t.lastFrame||(t.lastFrame=s),s-t.lastFrame<1e3/t.fps||(t.currentFrame||(t.currentFrame=0),++t.currentFrame,t.lastFrame=s,t.draw())}},this.run=function(){requestAnimationFrame(this.animationFrameCallback())},this.getRotationOffset=function(){return this.staticRotation},this.rotateByMouse=function(){return{x:.01*this.Mouse.delta.x,y:.01*this.Mouse.delta.y,z:0}},this.colorStatic=function(t){return function(){return t}},this.color=this.colorStatic("currentColor"),this.Mouse={x:0,y:0,delta:{x:0,y:0}},this.mouseInterval=null,this.mouseUpdate=function(){var t=this;return function(e){var s={x:t.Mouse.x-e.pageX,y:t.Mouse.y-e.pageY};t.Mouse={x:e.pageX,y:e.pageY,delta:s},t.mouseInterval&&(clearInterval(t.mouseInterval),t.mouseInterval=!1),t.mouseInterval=setInterval(function(){t.Mouse.delta={x:0,y:0}},100)}}}
